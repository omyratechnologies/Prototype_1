import { useParams, useNavigate, useLocation } from "react-router-dom";
import { useState, useEffect } from "react";
import { useProduct } from "../hooks/useProducts";
import { useAuth } from "../context/AuthContext";
import { useCart } from "../context/CartContext";
import { LoadingSpinner, ErrorMessage } from "../components/ui/Loading";
import NavBar from "../components/Navbar";
import { 
  FaExpand, 
  FaChevronLeft, 
  FaChevronRight,
  FaShoppingCart,
  FaHeart,
  FaShare,
  FaRuler,
  FaWeight,
  FaShieldAlt,
  FaStar,
  FaCheck,
  FaInfoCircle
} from "react-icons/fa";

export default function ProductDetailPage() {
  const { categoryId, typeId, varietyId } = useParams();
  const { addToCart } = useCart();
  const { user, logout } = useAuth();
  const navigate = useNavigate();
  const location = useLocation();

  // Get navigation state data
  const { productId, productName } = location.state || {};

  // Fetch product details from API
  const { product, loading, error } = useProduct(productId);
  const [relatedProducts, setRelatedProducts] = useState([]);
  const [loadingRelated, setLoadingRelated] = useState(false);

  // UI States
  const [selectedImage, setSelectedImage] = useState("");
  const [currentImageIndex, setCurrentImageIndex] = useState(0);
  const [showImageModal, setShowImageModal] = useState(false);
  const [activeTab, setActiveTab] = useState("overview");
  const [selectedSize, setSelectedSize] = useState(null);
  const [crateQty, setCrateQty] = useState(0);
  const [pieceQty, setPieceQty] = useState(0);
  const [isWishlisted, setIsWishlisted] = useState(false);

  // Modal states
  const [showWarning, setShowWarning] = useState(true);
  const [showConfirmModal, setShowConfirmModal] = useState(false);
  const [showSizeError, setShowSizeError] = useState(false);
  const [addedToCart, setAddedToCart] = useState(false);
  const [showLoginModal, setShowLoginModal] = useState(false);

  // Set initial image when product loads
  useEffect(() => {
    if (product && product.images && product.images.length > 0) {
      setSelectedImage(product.images[0]);
      setCurrentImageIndex(0);
    }
  }, [product]);

  // Fetch related products
  useEffect(() => {
    const fetchRelatedProducts = async () => {
      if (!productId) return;
      
      setLoadingRelated(true);
      try {
        const response = await fetch(`/api/granite/products/${productId}/related`);
        if (response.ok) {
          const data = await response.json();
          setRelatedProducts(data.data || []);
        }
      } catch (error) {
        console.error('Error fetching related products:', error);
      } finally {
        setLoadingRelated(false);
      }
    };

    fetchRelatedProducts();
  }, [productId]);

  // Image navigation
  const nextImage = () => {
    if (product?.images) {
      const nextIndex = (currentImageIndex + 1) % product.images.length;
      setCurrentImageIndex(nextIndex);
      setSelectedImage(product.images[nextIndex]);
    }
  };

  const prevImage = () => {
    if (product?.images) {
      const prevIndex = currentImageIndex === 0 ? product.images.length - 1 : currentImageIndex - 1;
      setCurrentImageIndex(prevIndex);
      setSelectedImage(product.images[prevIndex]);
    }
  };

  // If no navigation state, show error
  if (!productId || !productName) {
    return (
      <div className="bg-white min-h-screen relative">
        <NavBar user={user} onLogout={logout} />
        <div className="max-w-6xl mx-auto px-4 py-8">
          <div className="text-center py-8">
            <p className="text-gray-600">Invalid product. Please navigate from the product varieties.</p>
            <button
              onClick={() => navigate('/')}
              className="mt-4 px-4 py-2 bg-black text-white rounded hover:bg-gray-800 transition"
            >
              Go Home
            </button>
          </div>
        </div>
      </div>
    );
  }

  if (loading) {
    return (
      <div className="bg-white min-h-screen relative">
        <NavBar user={user} onLogout={logout} />
        <div className="max-w-6xl mx-auto px-4 py-8">
          <div className="flex justify-center items-center py-20">
            <LoadingSpinner size="lg" />
          </div>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="bg-white min-h-screen relative">
        <NavBar user={user} onLogout={logout} />
        <div className="max-w-6xl mx-auto px-4 py-8">
          <ErrorMessage 
            error={error} 
            onRetry={() => window.location.reload()} 
          />
        </div>
      </div>
    );
  }

  // Handle "product not found" gracefully
  if (!product) {
    return (
      <div className="bg-white min-h-screen relative">
        <NavBar user={user} onLogout={logout} />
        <div className="max-w-6xl mx-auto px-4 py-8">
          <div className="text-center py-8">
            <p className="text-gray-600">Product not found.</p>
            <button
              onClick={() => navigate(-1)}
              className="mt-4 px-4 py-2 bg-black text-white rounded hover:bg-gray-800 transition"
            >
              Go Back
            </button>
          </div>
        </div>
      </div>
    );
  }

  const handleAddToCart = async () => {
    if (!user) {
      setShowLoginModal(true);
      return;
    }

    if (!selectedSize) {
      setShowSizeError(true);
      setTimeout(() => setShowSizeError(false), 3000);
      return;
    }

    if (totalPieces === 0) {
      alert("Please select at least one piece or crate.");
      return;
    }

    const totalWeight = totalPieces * selectedSize.weightPerPiece;
    if (totalWeight > 3000) {
      setShowConfirmModal(true);
    } else {
      await actuallyAddToCart();
    }
  };

  // Create size options from product data
  const sizeOptions = [{
    size: `${product.dimensions?.length || 0}x${product.dimensions?.width || 0}x${product.dimensions?.thickness || 0}`,
    weightPerPiece: product.weight_per_piece || 1,
    piecesPerCrate: product.packaging?.pieces_per_crate || 1,
    price: product.pricing?.price_per_unit || 0,
    stock: product.stock || 0
  }];

  const totalPieces = crateQty * (selectedSize?.piecesPerCrate || 0) + pieceQty;
  const totalWeight = totalPieces * (selectedSize?.weightPerPiece || 0);

  const actuallyAddToCart = async () => {
    try {
      // For now, we'll add the total pieces as quantity
      // The backend will handle the product details
      await addToCart(product._id, totalPieces);
      setAddedToCart(true);
      setTimeout(() => setAddedToCart(false), 2000);
    } catch (error) {
      console.error('Error adding to cart:', error);
      alert(error.message || 'Failed to add item to cart');
    }
  };

  return (
    <div className="bg-white min-h-screen relative">
      <NavBar user={user} onLogout={logout} />
      <div className="max-w-6xl mx-auto p-4 pt-8">
        {/* Breadcrumb */}
        <nav className="text-sm text-gray-500 mb-6">
          <span onClick={() => navigate("/")} className="cursor-pointer hover:text-black">
            Home
          </span>
          {" > "}
          <span onClick={() => navigate(-3)} className="cursor-pointer hover:text-black">
            Products
          </span>
          {" > "}
          <span onClick={() => navigate(-2)} className="cursor-pointer hover:text-black">
            {product.granite_variant?.name}
          </span>
          {" > "}
          <span onClick={() => navigate(-1)} className="cursor-pointer hover:text-black">
            {product.specific_granite_variant?.name}
          </span>
          {" > "}
          <span className="text-black">{product.name}</span>
        </nav>

        <div className="grid md:grid-cols-2 gap-8">
          {/* Images Section */}
          <div className="space-y-4">
            <div className="aspect-square bg-gray-100 rounded-lg overflow-hidden">
              <img
                src={selectedImage || "/granite-landscaping-products.png"}
                alt={product.name}
                className="w-full h-full object-cover"
              />
            </div>

            {/* Thumbnail Images */}
            {product.images && product.images.length > 1 && (
              <div className="flex gap-2 overflow-x-auto">
                {product.images.map((image, index) => (
                  <button
                    key={index}
                    onClick={() => setSelectedImage(image)}
                    className={`flex-shrink-0 w-20 h-20 bg-gray-100 rounded border-2 overflow-hidden
                      ${selectedImage === image ? "border-black" : "border-gray-200"}
                    `}
                  >
                    <img
                      src={image}
                      alt={`${product.name} ${index + 1}`}
                      className="w-full h-full object-cover"
                    />
                  </button>
                ))}
              </div>
            )}
          </div>

          {/* Product Details */}
          <div className="space-y-6">
            <div>
              <h1 className="text-3xl font-bold text-gray-900">{product.name}</h1>
              <p className="text-gray-600">
                {product.variantSpecificId?.variantId?.name} • {product.variantSpecificId?.name}
              </p>
            </div>

            {/* <div className="bg-gray-50 p-4 rounded">
              <p className="text-sm text-gray-600">{product.description}</p>
            </div> */}

            {/* Size Selection */}
            <div className="space-y-2">
              <label className="block text-sm font-medium text-gray-900">
                Size (L x W x T)
              </label>
              <div className="grid gap-2">
                {sizeOptions.map((option, index) => (
                  <button
                    key={index}
                    onClick={() => setSelectedSize(option)}
                    className={`p-3 border rounded text-left transition-colors
                      ${selectedSize === option
                        ? "border-black bg-black text-white"
                        : "border-gray-300 bg-white hover:border-gray-400"
                      }
                    `}
                  >
                    <div className="flex justify-between items-center">
                      <span>{option.size} cm</span>
                      <span className="font-semibold">₹{option.price}/piece</span>
                    </div>
                    <div className="text-xs opacity-70 mt-1">
                      {option.weightPerPiece}kg/piece • {option.piecesPerCrate} pieces/crate • Stock: {option.stock}
                    </div>
                  </button>
                ))}
              </div>
              {showSizeError && (
                <p className="text-red-500 text-sm">Please select a size first.</p>
              )}
            </div>

            {/* Quantity Selection */}
            {selectedSize && (
              <div className="space-y-4">
                <h3 className="text-lg font-semibold">Select Quantity</h3>
                
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      Crates ({selectedSize.piecesPerCrate} pieces each)
                    </label>
                    <div className="flex items-center border border-gray-300 rounded">
                      <button
                        onClick={() => setCrateQty(Math.max(0, crateQty - 1))}
                        className="px-3 py-2 text-gray-600 hover:bg-gray-100"
                      >
                        -
                      </button>
                      <input
                        type="number"
                        value={crateQty}
                        onChange={(e) => setCrateQty(Math.max(0, parseInt(e.target.value) || 0))}
                        className="flex-1 px-3 py-2 text-center border-0 focus:ring-0"
                        min="0"
                      />
                      <button
                        onClick={() => setCrateQty(crateQty + 1)}
                        className="px-3 py-2 text-gray-600 hover:bg-gray-100"
                      >
                        +
                      </button>
                    </div>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      Individual Pieces
                    </label>
                    <div className="flex items-center border border-gray-300 rounded">
                      <button
                        onClick={() => setPieceQty(Math.max(0, pieceQty - 1))}
                        className="px-3 py-2 text-gray-600 hover:bg-gray-100"
                      >
                        -
                      </button>
                      <input
                        type="number"
                        value={pieceQty}
                        onChange={(e) => setPieceQty(Math.max(0, parseInt(e.target.value) || 0))}
                        className="flex-1 px-3 py-2 text-center border-0 focus:ring-0"
                        min="0"
                      />
                      <button
                        onClick={() => setPieceQty(pieceQty + 1)}
                        className="px-3 py-2 text-gray-600 hover:bg-gray-100"
                      >
                        +
                      </button>
                    </div>
                  </div>
                </div>

                {/* Total Summary */}
                {totalPieces > 0 && (
                  <div className="bg-gray-50 p-4 rounded space-y-2">
                    <div className="flex justify-between text-sm">
                      <span>Total Pieces:</span>
                      <span className="font-medium">{totalPieces}</span>
                    </div>
                    <div className="flex justify-between text-sm">
                      <span>Total Weight:</span>
                      <span className="font-medium">{totalWeight}kg</span>
                    </div>
                    <div className="flex justify-between text-lg font-bold border-t pt-2">
                      <span>Total Cost:</span>
                      <span>₹{(totalPieces * selectedSize.price).toLocaleString()}</span>
                    </div>
                  </div>
                )}

                {/* Weight Warning */}
                {totalWeight > 3000 && showWarning && (
                  <div className="bg-yellow-50 border border-yellow-200 p-3 rounded">
                    <div className="flex justify-between items-start">
                      <div>
                        <h4 className="font-medium text-yellow-800">Heavy Order Notice</h4>
                        <p className="text-sm text-yellow-700">
                          This order weighs {totalWeight}kg. Special shipping arrangements may apply.
                        </p>
                      </div>
                      <button
                        onClick={() => setShowWarning(false)}
                        className="text-yellow-500 hover:text-yellow-700"
                      >
                        ×
                      </button>
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* Add to Cart Button */}
            <button
              onClick={handleAddToCart}
              disabled={!selectedSize || totalPieces === 0}
              className={`w-full py-3 px-6 rounded-lg font-medium transition-all duration-200
                ${!selectedSize || totalPieces === 0
                  ? "bg-gray-300 text-gray-500 cursor-not-allowed"
                  : addedToCart
                  ? "bg-green-600 text-white"
                  : "bg-black text-white hover:bg-gray-800"
                }
              `}
            >
              {addedToCart ? "✓ Added to Cart!" : "Add to Cart"}
            </button>

            {/* Product Specifications */}
            <div className="border-t pt-6 space-y-4">
              <h3 className="text-lg font-semibold">Specifications</h3>
              <div className="grid grid-cols-2 gap-4 text-sm">
                <div>
                  <span className="text-gray-600">Material:</span>
                  <span className="ml-2 font-medium">{product.material || 'Granite'}</span>
                </div>
                <div>
                  <span className="text-gray-600">Finish:</span>
                  <span className="ml-2 font-medium">{product.finish || 'Polished'}</span>
                </div>
                <div>
                  <span className="text-gray-600">Origin:</span>
                  <span className="ml-2 font-medium">{product.origin || 'India'}</span>
                </div>
                <div>
                  <span className="text-gray-600">Usage:</span>
                  <span className="ml-2 font-medium">{product.recommended_usage || 'Indoor/Outdoor'}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Heavy Order Confirmation Modal */}
      {showConfirmModal && (
        <div className="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
          <div className="bg-white p-6 rounded-lg shadow-lg max-w-md w-full">
            <h2 className="text-lg font-semibold mb-4">Heavy Order Confirmation</h2>
            <p className="text-sm text-gray-600 mb-4">
              Your order weighs {totalWeight}kg, which may require special shipping arrangements. 
              Additional shipping charges may apply. Do you want to proceed?
            </p>
            <div className="flex justify-end gap-4">
              <button
                onClick={() => setShowConfirmModal(false)}
                className="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400"
              >
                Cancel
              </button>
              <button
                onClick={async () => {
                  setShowConfirmModal(false);
                  await actuallyAddToCart();
                }}
                className="px-4 py-2 bg-black text-white rounded hover:bg-gray-900"
              >
                Proceed Anyway
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Login Required Modal */}
      {showLoginModal && (
        <div className="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
          <div className="bg-white p-6 rounded-lg shadow-lg max-w-sm w-full text-center">
            <h2 className="text-lg font-semibold mb-4">Login Required</h2>
            <p className="text-sm text-gray-600 mb-4">
              You must log in to add items to your cart.
            </p>
            <div className="flex justify-center gap-4">
              <button
                onClick={() => setShowLoginModal(false)}
                className="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400"
              >
                Cancel
              </button>
              <button
                onClick={() => {
                  setShowLoginModal(false);
                  navigate("/login", {
                    state: { from: location.pathname },
                  });
                }}
                className="px-4 py-2 bg-black text-white rounded hover:bg-gray-900"
              >
                Login
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
